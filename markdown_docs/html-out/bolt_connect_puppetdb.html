<!DOCTYPE html
  SYSTEM "about:legacy-compat">
<html lang="en"><head><meta http-equiv="Content-Type" content="text/html; charset=UTF-8"><meta charset="UTF-8"><meta name="copyright" content="(C) Copyright 2019"><meta name="DC.rights.owner" content="(C) Copyright 2019"><meta name="DC.type" content="topic"><meta name="DC.creator" content="Kate Lopresti <kate.lopresti@puppet.com\&gt;"><meta name="DC.format" content="HTML5"><meta name="DC.identifier" content="connecting-bolt-to-puppetdb"><link rel="stylesheet" type="text/css" href="commonltr.css"><title>Connecting Bolt to PuppetDB</title></head><body id="connecting-bolt-to-puppetdb"><main role="main"><article role="article" aria-labelledby="ariaid-title1"><h1 class="title topictitle1" id="ariaid-title1">Connecting Bolt to PuppetDB</h1><div class="body"><p class="p">Configure Bolt to connect to PuppetDB.</p></div><article class="topic nested1" aria-labelledby="ariaid-title2" id="puppetdb-authorization"><h2 class="title topictitle2" id="ariaid-title2">PuppetDB authorization</h2><div class="body"><p class="p">Bolt can authenticate with PuppetDB through an SSL client certificate or a PE RBAC token.</p></div></article><article class="topic nested1" aria-labelledby="ariaid-title3" id="client-certificate"><h2 class="title topictitle2" id="ariaid-title3">Client certificate</h2><div class="body"><p class="p">Add the certname for the certificate you want to authenticate with to&nbsp;/<code class="ph codeph">etc/puppetlabs/puppetdb/certificate-whitelist</code>. This certificate has full access to all PuppetDB API endpoints and can read all data, push new data, or run commands on PuppetDB. To test the certificate you run the following curl command.</p><pre class="pre codeblock"><code>curl -X GET $SERVER_URL/pdb/query/v4 --data-urlencode 'query=nodes[certname] {}' --cert $CERT_PATH --key $KEY_PATH --cacert $CACERT_PATH</code></pre></div></article><article class="topic nested1" aria-labelledby="ariaid-title4" id="token-based-authentication-with-pe-rbac-token"><h2 class="title topictitle2" id="ariaid-title4">Token-based authentication with PE RBAC token</h2><div class="body"><p class="p">If you use Puppet Enterprise you can grant more restricted access to PuppetDB with a PE role-based access control \(RBAC\) token.</p><ol class="ol"><li class="li"><p class="p">In PE, verify you are assigned to a role that has the appropriate RBAC permission. It needs the permission type <strong class="ph b">Nodes</strong> and the action <strong class="ph b">View node data from&nbsp;PuppetDB</strong>.</p></li><li class="li"><p class="p">From the command line, run&nbsp;<code class="ph codeph">puppet-access login --lifetime &lt;TIME PERIOD&gt;</code>.</p></li><li class="li"><p class="p">When prompted, enter the same username and password that you use to log into the PE console. The token is generated and stored in a file for later use. The default location for storing the token is&nbsp;~/.puppetlabs/token.&nbsp;</p></li><li class="li"><p class="p">Verify that authentication is working with the following curl command.</p></li></ol><pre class="pre codeblock"><code>curl -X GET https://$SERVER_URL/pdb/query/v4 --data-urlencode 'query=nodes[certname] {}' -H "X-Authentication: `cat ~/.puppetlabs/token`" --cacert $CACERT_PATH</code></pre></div></article><article class="topic nested1" aria-labelledby="ariaid-title5" id="configuration"><h2 class="title topictitle2" id="ariaid-title5">Configuration</h2><div class="body"><p class="p">To configure the BoltPuppetDB client, add a&nbsp;<code class="ph codeph">puppetdb</code>&nbsp;section to <code class="ph codeph">~/.puppetlabs/bolt/bolt.yaml</code> with the following values:</p><ul class="ul"><li class="li"><p class="p"><code class="ph codeph">server-urls</code>: An array containing the PuppetDB host to connect to. This should include the protocol&nbsp;<code class="ph codeph">https</code>&nbsp;and the port is usually&nbsp;<code class="ph codeph">8081</code>. For example&nbsp;<code class="ph codeph">https://my-master.example.com:8081</code></p></li><li class="li"><p class="p"><code class="ph codeph">cacert</code>: The path the ca certificate for puppetdb</p></li></ul><p class="p">If you are using certificate authentication also set:</p><ul class="ul"><li class="li"><p class="p"><code class="ph codeph">cert</code>: The path to the client certificate file to use for authentication</p></li><li class="li"><p class="p"><code class="ph codeph">key</code>: The private key for that certificate</p></li></ul><p class="p">If you are using a PE RBAC token set:</p><ul class="ul"><li class="li"><p class="p"><code class="ph codeph">token</code>: The path to the PE RBAC Token.</p></li></ul><p class="p">For example, to use certificate authentication:</p><pre class="pre codeblock"><code>puppetdb:
  server_urls: ["https://puppet.example.com:8081"]
  cacert: /etc/puppetlabs/puppet/ssl/certs/ca.pem
  cert: /etc/puppetlabs/puppet/ssl/certs/my-host.example.com.pem
  key: /etc/puppetlabs/puppet/ssl/private_keys/my-host.example.com.pem</code></pre><p class="p">If PE is installed and PuppetDB is not defined in a config file, Bolt uses the PuppetDB config defined in either: <code class="ph codeph">$HOME/.puppetlabs/client-tools/puppetdb.conf</code>or <code class="ph codeph">/etc/puppetlabs/client-tools/puppetdb.conf</code> \(Windows: <code class="ph codeph">C:\ProgramData\PuppetLabs\client-tools\puppetdb.conf</code>\).</p><p class="p"><strong class="ph b">Important:</strong> Bolt does not merge config files into a conf.d format the way that pe-client-tools does.</p><p class="p">To use PE RBAC authentication:</p><pre class="pre codeblock"><code>puppetdb:
  server_urls: ["https://puppet.example.com:8081"]
  cacert: /etc/puppetlabs/puppet/ssl/certs/ca.pem
  token: ~/.puppetlabs/token</code></pre></div></article><article class="topic nested1" aria-labelledby="ariaid-title6" id="testing"><h2 class="title topictitle2" id="ariaid-title6">Testing</h2><div class="body"><p class="p">You can test your configuration with the following plan, which returns a list of all nodes in PuppetDB.</p><pre class="pre codeblock"><code>plan pdb_test {
  return(puppetdb_query("nodes[certname] {}"))
}</code></pre><p class="p"><strong class="ph b">Parent topic:</strong><a class="xref" href="configuring_bolt.html">Configuring Bolt</a></p></div></article></article></main></body></html>