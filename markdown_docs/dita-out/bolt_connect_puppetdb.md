<?xml version="1.0" encoding="UTF-8"?><?path2rootmap-uri ./?>
<!DOCTYPE topic
  PUBLIC "-//OASIS//DTD DITA Topic//EN" "topic.dtd">
<topic id="connecting-bolt-to-puppetdb"><title>Connecting Bolt to PuppetDB</title><prolog><author>Kate Lopresti &lt;kate.lopresti@puppet.com\&gt;</author></prolog><body><p>Configure Bolt to connect to PuppetDB.</p></body><topic id="puppetdb-authorization"><title>PuppetDB authorization</title><body><p>Bolt can authenticate with PuppetDB through an SSL client certificate or a PE RBAC token.</p></body></topic><topic id="client-certificate"><title>Client certificate</title><body><p>Add the certname for the certificate you want to authenticate with to /<codeph>etc/puppetlabs/puppetdb/certificate-whitelist</codeph>. This certificate has full access to all PuppetDB API endpoints and can read all data, push new data, or run commands on PuppetDB. To test the certificate you run the following curl command.</p><codeblock xml:space="preserve">curl -X GET $SERVER_URL/pdb/query/v4 --data-urlencode 'query=nodes[certname] {}' --cert $CERT_PATH --key $KEY_PATH --cacert $CACERT_PATH</codeblock></body></topic><topic id="token-based-authentication-with-pe-rbac-token"><title>Token-based authentication with PE RBAC token</title><body><p>If you use Puppet Enterprise you can grant more restricted access to PuppetDB with a PE role-based access control \(RBAC\) token.</p><ol><li><p>In PE, verify you are assigned to a role that has the appropriate RBAC permission. It needs the permission type <b>Nodes</b> and the action <b>View node data from PuppetDB</b>.</p></li><li><p>From the command line, run <codeph>puppet-access login --lifetime &lt;TIME PERIOD&gt;</codeph>.</p></li><li><p>When prompted, enter the same username and password that you use to log into the PE console. The token is generated and stored in a file for later use. The default location for storing the token is ~/.puppetlabs/token. </p></li><li><p>Verify that authentication is working with the following curl command.</p></li></ol><codeblock xml:space="preserve">curl -X GET https://$SERVER_URL/pdb/query/v4 --data-urlencode 'query=nodes[certname] {}' -H "X-Authentication: `cat ~/.puppetlabs/token`" --cacert $CACERT_PATH</codeblock></body></topic><topic id="configuration"><title>Configuration</title><body><p>To configure the BoltPuppetDB client, add a <codeph>puppetdb</codeph> section to <codeph>~/.puppetlabs/bolt/bolt.yaml</codeph> with the following values:</p><ul><li><p><codeph>server-urls</codeph>: An array containing the PuppetDB host to connect to. This should include the protocol <codeph>https</codeph> and the port is usually <codeph>8081</codeph>. For example <codeph>https://my-master.example.com:8081</codeph></p></li><li><p><codeph>cacert</codeph>: The path the ca certificate for puppetdb</p></li></ul><p>If you are using certificate authentication also set:</p><ul><li><p><codeph>cert</codeph>: The path to the client certificate file to use for authentication</p></li><li><p><codeph>key</codeph>: The private key for that certificate</p></li></ul><p>If you are using a PE RBAC token set:</p><ul><li><p><codeph>token</codeph>: The path to the PE RBAC Token.</p></li></ul><p>For example, to use certificate authentication:</p><codeblock xml:space="preserve">puppetdb:
  server_urls: ["https://puppet.example.com:8081"]
  cacert: /etc/puppetlabs/puppet/ssl/certs/ca.pem
  cert: /etc/puppetlabs/puppet/ssl/certs/my-host.example.com.pem
  key: /etc/puppetlabs/puppet/ssl/private_keys/my-host.example.com.pem</codeblock><p>If PE is installed and PuppetDB is not defined in a config file, Bolt uses the PuppetDB config defined in either: <codeph>$HOME/.puppetlabs/client-tools/puppetdb.conf</codeph>or <codeph>/etc/puppetlabs/client-tools/puppetdb.conf</codeph> \(Windows: <codeph>C:\ProgramData\PuppetLabs\client-tools\puppetdb.conf</codeph>\).</p><p><b>Important:</b> Bolt does not merge config files into a conf.d format the way that pe-client-tools does.</p><p>To use PE RBAC authentication:</p><codeblock xml:space="preserve">puppetdb:
  server_urls: ["https://puppet.example.com:8081"]
  cacert: /etc/puppetlabs/puppet/ssl/certs/ca.pem
  token: ~/.puppetlabs/token</codeblock></body></topic><topic id="testing"><title>Testing</title><body><p>You can test your configuration with the following plan, which returns a list of all nodes in PuppetDB.</p><codeblock xml:space="preserve">plan pdb_test {
  return(puppetdb_query("nodes[certname] {}"))
}</codeblock><p><b>Parent topic:</b><xref href="configuring_bolt.md" format="dita" type="topic">Configuring Bolt</xref></p></body></topic></topic>